<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue - ChemistrySpot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/chemspotV1-dt6tDoOKp1wAyi8oRMzxzufIVBfiu9.png" alt="ChemistrySpot Logo" class="logo">
                    <span class="logo-text">ChemistrySpot</span>
                </div>
                
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Accueil</a></li>
                    <li><a href="catalogue.html" class="nav-link active">Catalogue</a></li>
                    <li><a href="fournisseurs.html" class="nav-link">Fournisseurs</a></li>
                    <li><a href="contact.html" class="nav-link">Contact</a></li>
                </ul>
                
                <div class="header-actions">
                    <button class="btn btn-outline btn-sm">
                        <i class="fas fa-shopping-cart"></i> Panier (0)
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="page-header-content">
                <h1>üì¶ Catalogue Produits</h1>
                <p>Explorez notre gamme compl√®te d'excipients pharmaceutiques</p>
                
                <!-- Barre de recherche -->
                <div class="search-container" style="max-width: 700px; margin: 2rem auto 0;">
                    <form class="search-form" onsubmit="handleSearch(event)">
                        <div class="search-input-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="catalogSearchInput" placeholder="Rechercher par nom, CAS, formule..." autocomplete="off">
                        </div>
                        <button type="submit">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Section Filtres -->
    <section class="section section-white">
        <div class="container">
            <!-- Stats rapides -->
            <div class="hero-stats" style="margin-bottom: 2rem;">
                <div class="stat-item">
                    <span class="stat-number" id="displayedProducts">0</span>
                    <span class="stat-label">Produits affich√©s</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="displayedReferences">0</span>
                    <span class="stat-label">R√©f√©rences disponibles</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalCategories">0</span>
                    <span class="stat-label">Cat√©gories</span>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters-section" style="background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div class="filters-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; color: var(--primary);">
                        <i class="fas fa-filter"></i> Filtres
                    </h3>
                    <button class="btn btn-sm btn-outline" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> R√©initialiser
                    </button>
                </div>
                
                <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div class="filter-group">
                        <label class="filter-label">Cat√©gorie</label>
                        <select id="filterCategorie" class="filter-select" onchange="applyFilters()">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Sous-cat√©gorie</label>
                        <select id="filterSousCategorie" class="filter-select" onchange="applyFilters()">
                            <option value="">Toutes les sous-cat√©gories</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Disponibilit√©</label>
                        <select id="filterStock" class="filter-select" onchange="applyFilters()">
                            <option value="">Tous</option>
                            <option value="available">En stock uniquement</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Trier par</label>
                        <select id="sortBy" class="filter-select" onchange="applyFilters()">
                            <option value="nom">Nom (A-Z)</option>
                            <option value="nom-desc">Nom (Z-A)</option>
                            <option value="prix-asc">Prix croissant</option>
                            <option value="prix-desc">Prix d√©croissant</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- R√©sultats -->
            <div id="catalogResults">
                <!-- Les produits seront affich√©s ici -->
            </div>

            <!-- Message si aucun r√©sultat -->
            <div id="noResults" style="display: none; text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-search" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3 style="color: var(--text-light);">Aucun produit trouv√©</h3>
                <p style="color: var(--text-light);">Essayez de modifier vos filtres de recherche</p>
            </div>

            <!-- Loading -->
            <div id="catalogLoading" style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
                <p style="margin-top: 1rem; color: var(--text-light);">Chargement des produits...</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>ChemistrySpot</h3>
                    <p>La marketplace B2B de r√©f√©rence pour les mati√®res premi√®res pharmaceutiques.</p>
                </div>
                
                <div class="footer-column">
                    <h3>Liens rapides</h3>
                    <ul>
                        <li><a href="index.html">Accueil</a></li>
                        <li><a href="catalogue.html">Catalogue</a></li>
                        <li><a href="fournisseurs.html">Fournisseurs</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>Contact</h3>
                    <p>Email: contact@chemistryspot.com</p>
                    <p>T√©l: +33 1 23 45 67 89</p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 ChemistrySpot. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="./js/supabase-config.js"></script>
    <script>
        // ===============================================
        // CATALOGUE PRODUCT-CENTRIC
        // ===============================================
        
        let allProductsData = [];
        let filteredProducts = [];
        let currentFilters = {
            categorie: '',
            sousCategorie: '',
            stock: '',
            query: ''
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            // Attendre que Supabase soit pr√™t
            await waitForSupabase();
            
            // Charger les produits
            await loadCatalogProducts();
            
            // Initialiser les filtres
            initializeFilters();
            
            // Afficher les produits
            displayProducts();
        });

        // Attendre que Supabase soit initialis√©
        async function waitForSupabase() {
            let attempts = 0;
            while (!window.ChemSpotDB && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 500));
                attempts++;
            }
            if (!window.ChemSpotDB) {
                throw new Error('ChemSpotDB non disponible');
            }
        }

        // Charger les produits avec r√©f√©rences
        async function loadCatalogProducts() {
            try {
                document.getElementById('catalogLoading').style.display = 'block';
                document.getElementById('catalogResults').style.display = 'none';
                
                allProductsData = await window.ChemSpotDB.getAllProductsWithReferences();
                filteredProducts = [...allProductsData];
                
                console.log(`‚úÖ ${allProductsData.length} produits charg√©s`);
                
                // Mettre √† jour les stats
                updateCatalogStats();
                
            } catch (error) {
                console.error('‚ùå Erreur chargement catalogue:', error);
                window.ChemSpotDB.showStatus('Erreur de chargement', 'error');
            } finally {
                document.getElementById('catalogLoading').style.display = 'none';
                document.getElementById('catalogResults').style.display = 'block';
            }
        }

        // Initialiser les filtres
        function initializeFilters() {
            const categories = window.ChemSpotDB.getCategories();
            const subCategories = window.ChemSpotDB.getSubCategories();
            
            const categorieSelect = document.getElementById('filterCategorie');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorieSelect.appendChild(option);
            });
            
            const subCatSelect = document.getElementById('filterSousCategorie');
            subCategories.forEach(subCat => {
                const option = document.createElement('option');
                option.value = subCat;
                option.textContent = subCat;
                subCatSelect.appendChild(option);
            });
        }

        // Appliquer les filtres
        function applyFilters() {
            currentFilters.categorie = document.getElementById('filterCategorie').value;
            currentFilters.sousCategorie = document.getElementById('filterSousCategorie').value;
            currentFilters.stock = document.getElementById('filterStock').value;
            
            filteredProducts = allProductsData.filter(product => {
                // Filtre cat√©gorie
                if (currentFilters.categorie && product.categorie !== currentFilters.categorie) {
                    return false;
                }
                
                // Filtre sous-cat√©gorie
                if (currentFilters.sousCategorie && product.sous_categorie !== currentFilters.sousCategorie) {
                    return false;
                }
                
                // Filtre stock
                if (currentFilters.stock === 'available') {
                    const hasStock = product.product_references?.some(ref => ref.stock_disponible);
                    if (!hasStock) return false;
                }
                
                // Filtre recherche
                if (currentFilters.query) {
                    const query = currentFilters.query.toLowerCase();
                    const matchName = product.nom?.toLowerCase().includes(query);
                    const matchCAS = product.cas_number?.toLowerCase().includes(query);
                    const matchFormula = product.formule_chimique?.toLowerCase().includes(query);
                    if (!matchName && !matchCAS && !matchFormula) return false;
                }
                
                return true;
            });
            
            // Tri
            const sortBy = document.getElementById('sortBy').value;
            sortProducts(sortBy);
            
            // Afficher
            displayProducts();
            updateCatalogStats();
        }

        // Trier les produits
        function sortProducts(sortBy) {
            switch(sortBy) {
                case 'nom':
                    filteredProducts.sort((a, b) => a.nom.localeCompare(b.nom));
                    break;
                case 'nom-desc':
                    filteredProducts.sort((a, b) => b.nom.localeCompare(a.nom));
                    break;
                case 'prix-asc':
                    filteredProducts.sort((a, b) => {
                        const priceA = getMinPrice(a.product_references);
                        const priceB = getMinPrice(b.product_references);
                        return priceA - priceB;
                    });
                    break;
                case 'prix-desc':
                    filteredProducts.sort((a, b) => {
                        const priceA = getMinPrice(a.product_references);
                        const priceB = getMinPrice(b.product_references);
                        return priceB - priceA;
                    });
                    break;
            }
        }

        // Obtenir prix minimum
        function getMinPrice(references) {
            if (!references || references.length === 0) return Infinity;
            return Math.min(...references.map(r => r.prix_euro || Infinity));
        }

        // Afficher les produits
        function displayProducts() {
            const container = document.getElementById('catalogResults');
            const noResults = document.getElementById('noResults');
            
            if (filteredProducts.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noResults.style.display = 'none';
            
            const html = `
                <div class="products-grid">
                    ${filteredProducts.map(product => createProductCard(product)).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Cr√©er carte produit
        function createProductCard(product) {
            const references = product.product_references || [];
            const minPrice = getMinPrice(references);
            const maxPrice = references.length > 0 ? Math.max(...references.map(r => r.prix_euro || 0)) : 0;
            const hasStock = references.some(r => r.stock_disponible);
            
            return `
                <div class="product-card fade-in">
                    <div class="product-name">${product.nom}</div>
                    ${product.nom_chimique ? `<div style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.5rem;">${product.nom_chimique}</div>` : ''}
                    
                    ${window.ChemSpotDB.createCategoryBadge(product.categorie, product.sous_categorie)}
                    
                    <div class="product-details">
                        <div class="detail-row">
                            <span class="label">CAS:</span>
                            <span class="value">${product.cas_number || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">CE:</span>
                            <span class="value">${product.ce_number || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">Formule:</span>
                            <span class="value">${product.formule_chimique || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">R√©f√©rences:</span>
                            <span class="value">${references.length} disponible(s)</span>
                        </div>
                    </div>
                    
                    ${product.description ? `
                        <p style="font-size: 0.9rem; color: var(--text-light); margin: 1rem 0; line-height: 1.5;">
                            ${window.ChemSpotDB.truncateText(product.description, 120)}
                        </p>
                    ` : ''}
                    
                    <div class="product-price">
                        ${minPrice !== Infinity ? 
                            (minPrice === maxPrice ? 
                                window.ChemSpotDB.formatPrice(minPrice) : 
                                `${window.ChemSpotDB.formatPrice(minPrice)} - ${window.ChemSpotDB.formatPrice(maxPrice)}`
                            ) : 
                            'Prix sur demande'}
                    </div>
                    
                    ${window.ChemSpotDB.formatAvailability(hasStock)}
                    
                    <button class="btn-quote" onclick="viewProduct(${product.id})">
                        <i class="fas fa-eye"></i> Voir d√©tails & r√©f√©rences
                    </button>
                </div>
            `;
        }

        // Voir d√©tail produit
        function viewProduct(productId) {
            window.location.href = `produit-detail.html?id=${productId}`;
        }

        // Recherche
        function handleSearch(event) {
            event.preventDefault();
            currentFilters.query = document.getElementById('catalogSearchInput').value;
            applyFilters();
        }

        // R√©initialiser filtres
        function resetFilters() {
            document.getElementById('filterCategorie').value = '';
            document.getElementById('filterSousCategorie').value = '';
            document.getElementById('filterStock').value = '';
            document.getElementById('sortBy').value = 'nom';
            document.getElementById('catalogSearchInput').value = '';
            currentFilters = {
                categorie: '',
                sousCategorie: '',
                stock: '',
                query: ''
            };
            applyFilters();
        }

        // Mettre √† jour stats
        function updateCatalogStats() {
            const totalRefs = filteredProducts.reduce((sum, p) => sum + (p.product_references?.length || 0), 0);
            const categories = [...new Set(filteredProducts.map(p => p.categorie))].length;
            
            document.getElementById('displayedProducts').textContent = filteredProducts.length;
            document.getElementById('displayedReferences').textContent = totalRefs;
            document.getElementById('totalCategories').textContent = categories;
        }
    </script>
<script>
// Script de chargement du catalogue
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üì¶ Chargement du catalogue...');
    
    // Attendre que ChemSpotDB soit pr√™t
    let attempts = 0;
    while (!window.ChemSpotDB && attempts < 20) {
        await new Promise(resolve => setTimeout(resolve, 500));
        attempts++;
    }
    
    if (!window.ChemSpotDB) {
        console.error('‚ùå ChemSpotDB non disponible');
        return;
    }
    
    try {
        // Charger les excipients
        const excipients = await window.ChemSpotDB.getAllExcipients();
        console.log(`‚úÖ ${excipients.length} excipients charg√©s`);
        
        // Afficher dans le catalogue
        displayExcipients(excipients);
        
    } catch (error) {
        console.error('‚ùå Erreur chargement catalogue:', error);
    }
});

// Fonction d'affichage des excipients
function displayExcipients(excipients) {
    const container = document.getElementById('productsContainer') || 
                     document.querySelector('.products-grid') ||
                     document.querySelector('.catalogue-grid');
    
    if (!container) {
        console.error('‚ùå Container produits non trouv√©');
        return;
    }
    
    // Vider le loading
    container.innerHTML = '';
    
    // Si aucun excipient
    if (!excipients || excipients.length === 0) {
        container.innerHTML = '<p class="no-results">Aucun excipient trouv√©</p>';
        return;
    }
    
    // Afficher les excipients
    excipients.forEach(excipient => {
        const card = createExcipientCard(excipient);
        container.innerHTML += card;
    });
    
    console.log(`‚úÖ ${excipients.length} excipients affich√©s`);
}

// Cr√©er une carte excipient
function createExcipientCard(excipient) {
    return `
        <div class="product-card">
            <div class="product-header">
                <h3>${excipient.nom_commun || 'Sans nom'}</h3>
                <span class="product-badge">Excipient</span>
            </div>
            <div class="product-details">
                <p><strong>Nom chimique:</strong> ${excipient.nom_chimique || 'N/A'}</p>
                <p><strong>CAS:</strong> ${excipient.cas_number || 'N/A'}</p>
                <p><strong>Formule:</strong> ${excipient.formule || 'N/A'}</p>
                <p><strong>Fonction:</strong> ${excipient.fonction_principale || 'N/A'}</p>
            </div>
            <div class="product-footer">
                <button class="btn btn-primary" onclick="viewExcipient(${excipient.id})">
                    <i class="fas fa-eye"></i> Voir d√©tails
                </button>
            </div>
        </div>
    `;
}

// Fonction voir d√©tails
function viewExcipient(id) {
    window.location.href = `produit-detail.html?id=${id}`;
}
</script>
    
</body>
</html>
