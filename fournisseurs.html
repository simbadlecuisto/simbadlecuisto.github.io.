// REMPLACE LE SCRIPT DANS FOURNISSEURS.HTML PAR CELUI-CI :

// Configuration Supabase
const SUPABASE_URL = 'https://jkaffpgqbyhuihvyvtld.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprYWZmcGdxYnlodWlodnl2dGxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NTgzOTQsImV4cCI6MjA2NzIzNDM5NH0.OIjoz6uoPV25Nraral4YN_gz7q6COBW3dAVIYhBy1pI';

let supabase;
let allSuppliers = [];
let filteredSuppliers = [];

// Initialisation
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('üîÑ Initialisation page fournisseurs...');
        
        // Cr√©er le client Supabase
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('‚úÖ Client Supabase cr√©√©');
        
        // Mettre √† jour le statut
        updateConnectionStatus(true);
        
        // Charger les fournisseurs
        await loadSuppliers();
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation:', error);
        updateConnectionStatus(false);
        showError('Erreur de connexion √† la base de donn√©es');
    }
});

function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (connected) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = '‚úÖ Connect√© √† la base de donn√©es';
        statusEl.style.display = 'block';
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = '‚ùå Erreur de connexion';
        statusEl.style.display = 'block';
    }
}

async function loadSuppliers() {
    try {
        console.log('üîÑ Chargement fournisseurs depuis Supabase...');
        
        // REQU√äTE CORRIG√âE : R√âCUP√âRER TOUTES LES COLONNES
        const { data: suppliers, error } = await supabase
            .from('suppliers')
            .select('*')  // ‚Üê MODIFI√â : R√©cup√®re toutes les colonnes
            .order('name');

        if (error) {
            console.error('‚ùå Erreur Supabase:', error);
            throw error;
        }

        console.log(`‚úÖ ${suppliers.length} fournisseurs charg√©s:`, suppliers);
        console.log('üìä Premier fournisseur:', suppliers[0]); // Pour voir la structure
        
        allSuppliers = suppliers || [];
        filteredSuppliers = [...allSuppliers];
        
        // Initialiser les filtres
        initializeFilters();
        
        // Afficher les fournisseurs
        displaySuppliers();
        
    } catch (error) {
        console.error('‚ùå Erreur chargement:', error);
        showError(`Erreur: ${error.message}`);
    }
}

function initializeFilters() {
    // Remplir le filtre pays
    const countries = [...new Set(allSuppliers.map(s => s.country).filter(Boolean))];
    const countryFilter = document.getElementById('countryFilter');
    countryFilter.innerHTML = '<option value="">Tous les pays</option>' +
        countries.map(country => `<option value="${country}">${country}</option>`).join('');

    // Remplir le filtre sp√©cialit√©s
    const specialties = [...new Set(allSuppliers.map(s => s.speciality).filter(Boolean))];
    const specialtyFilter = document.getElementById('specialtyFilter');
    specialtyFilter.innerHTML = '<option value="">Toutes les sp√©cialit√©s</option>' +
        specialties.map(specialty => `<option value="${specialty}">${specialty}</option>`).join('');
}

function displaySuppliers() {
    const loadingEl = document.getElementById('loadingMessage');
    const errorEl = document.getElementById('errorMessage');
    const containerEl = document.getElementById('suppliersContainer');
    const countEl = document.getElementById('resultsCount');

    // Cacher loading/error
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';

    // Mettre √† jour compteur
    countEl.textContent = `${filteredSuppliers.length} fournisseur(s) trouv√©(s)`;

    if (filteredSuppliers.length === 0) {
        containerEl.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                <i class="fas fa-search" style="font-size: 3rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                <h3 style="color: #4a5568; margin-bottom: 0.5rem;">Aucun fournisseur trouv√©</h3>
                <p style="color: #718096;">Essayez de modifier vos crit√®res de recherche</p>
            </div>
        `;
        containerEl.style.display = 'grid';
        return;
    }

    // G√©n√©rer les cartes
    const suppliersHTML = filteredSuppliers.map(supplier => createSupplierCard(supplier)).join('');
    containerEl.innerHTML = suppliersHTML;
    containerEl.style.display = 'grid';

    console.log(`‚úÖ ${filteredSuppliers.length} fournisseurs affich√©s`);
}

function createSupplierCard(supplier) {
    // Fonction pour obtenir emoji pays
    function getCountryFlag(country) {
        const flags = {
            'France': 'üá´üá∑', 'Allemagne': 'üá©üá™', 'Inde': 'üáÆüá≥', 'Chine': 'üá®üá≥',
            'Italie': 'üáÆüáπ', 'Espagne': 'üá™üá∏', 'Pays-Bas': 'üá≥üá±', 'Belgique': 'üáßüá™',
            'Suisse': 'üá®üá≠', 'Pologne': 'üáµüá±', 'USA': 'üá∫üá∏', '√âtats-Unis': 'üá∫üá∏',
            'Japon': 'üáØüáµ', 'Cor√©e': 'üá∞üá∑', 'Br√©sil': 'üáßüá∑', 'Allemagne/Belgique': 'üá©üá™üáßüá™',
            'Allemagne/Suisse': 'üá©üá™üá®üá≠', 'Espagne': 'üá™üá∏', 'Allemagne/Royaume-Uni': 'üá©üá™üá¨üáß'
        };
        return flags[country] || 'üåç';
    }

    // G√©rer les certifications (peut √™tre un array ou string)
    let certificationsDisplay = '';
    if (supplier.certifications) {
        let certs = supplier.certifications;
        if (typeof certs === 'string') {
            certs = certs.split(',').map(c => c.trim());
        }
        if (Array.isArray(certs)) {
            certificationsDisplay = certs.slice(0, 3).map(cert => 
                `<span class="cert-badge">${cert}</span>`
            ).join('');
            if (certs.length > 3) {
                certificationsDisplay += `<span class="cert-badge">+${certs.length - 3}</span>`;
            }
        }
    }

    return `
        <div class="supplier-card">
            <div class="supplier-header">
                <h3 class="supplier-name">${supplier.name || 'Nom non disponible'}</h3>
                <div class="supplier-id">#${supplier.id}</div>
            </div>
            
            <div class="supplier-info">
                ${supplier.country ? `
                    <div class="info-item">
                        <span class="country-flag">${getCountryFlag(supplier.country)}</span>
                        <strong>Pays :</strong> ${supplier.country}
                    </div>
                ` : ''}
                
                ${supplier.website ? `
                    <div class="info-item">
                        <i class="fas fa-globe"></i>
                        <strong>Site web :</strong> <a href="${supplier.website}" target="_blank">${supplier.website}</a>
                    </div>
                ` : ''}
                
                ${supplier.contact_email ? `
                    <div class="info-item">
                        <i class="fas fa-envelope"></i>
                        <strong>Email :</strong> <a href="mailto:${supplier.contact_email}">${supplier.contact_email}</a>
                    </div>
                ` : ''}
                
                ${supplier.speciality ? `
                    <div class="info-item">
                        <i class="fas fa-tags"></i>
                        <strong>Sp√©cialit√© :</strong> ${supplier.speciality}
                    </div>
                ` : ''}
            </div>
            
            ${certificationsDisplay ? `
                <div class="certifications" style="margin: 1rem 0;">
                    <strong>Certifications :</strong><br>
                    ${certificationsDisplay}
                </div>
            ` : ''}
            
            ${supplier.speciality ? `
                <div class="specialties">
                    <span class="specialty-tag">${supplier.speciality}</span>
                </div>
            ` : ''}
            
            ${supplier.notes ? `
                <div class="supplier-notes" style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-size: 0.875rem; color: #4a5568;">
                    <strong>Notes :</strong> ${supplier.notes}
                </div>
            ` : ''}
            
            <div class="supplier-actions">
                <button class="btn btn-primary" onclick="contactSupplier(${supplier.id}, '${supplier.name}', '${supplier.contact_email || ''}')">
                    <i class="fas fa-envelope"></i> Contacter
                </button>
                ${supplier.website ? `
                    <button class="btn btn-outline" onclick="visitWebsite('${supplier.website}')">
                        <i class="fas fa-external-link-alt"></i> Site web
                    </button>
                ` : ''}
                <button class="btn btn-outline" onclick="viewProducts(${supplier.id})">
                    <i class="fas fa-eye"></i> Produits
                </button>
            </div>
        </div>
    `;
}

function filterSuppliers() {
    const country = document.getElementById('countryFilter').value;
    const specialty = document.getElementById('specialtyFilter').value;

    filteredSuppliers = allSuppliers.filter(supplier => {
        const matchCountry = !country || supplier.country === country;
        const matchSpecialty = !specialty || supplier.speciality === specialty;
        return matchCountry && matchSpecialty;
    });

    displaySuppliers();
}

function resetFilters() {
    document.getElementById('countryFilter').value = '';
    document.getElementById('specialtyFilter').value = '';
    filteredSuppliers = [...allSuppliers];
    displaySuppliers();
}

function showError(message) {
    const loadingEl = document.getElementById('loadingMessage');
    const errorEl = document.getElementById('errorMessage');
    const containerEl = document.getElementById('suppliersContainer');
    const countEl = document.getElementById('resultsCount');

    loadingEl.style.display = 'none';
    containerEl.style.display = 'none';
    countEl.textContent = '';
    
    errorEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    errorEl.style.display = 'block';
}

function contactSupplier(supplierId, supplierName, email) {
    const subject = encodeURIComponent(`Demande de renseignements - ${supplierName} via ChemSpot`);
    const body = encodeURIComponent(`Bonjour,\n\nJe vous contacte via la plateforme ChemSpot concernant vos produits.\n\nCordialement`);
    
    if (email) {
        window.open(`mailto:${email}?subject=${subject}&body=${body}`);
    } else {
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
}

function visitWebsite(url) {
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        url = 'https://' + url;
    }
    window.open(url, '_blank');
}

function viewProducts(supplierId) {
    window.location.href = `catalogue.html?supplier=${supplierId}`;
}
